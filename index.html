<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<title>MealZ</title>
		
		<link rel="stylesheet" type="text/css" href="material-elements.css" />
		<link rel="stylesheet" type="text/css" href="material-depth.css" />
		<link rel="stylesheet" type="text/css" href="material-widgets.css" />
		<link rel="stylesheet" type="text/css" media="(prefers-color-scheme: dark)" href="material-dark.css" />
		<script type="text/javascript" src="material-touch.js"></script>
		
		<!-- jQuery is required for the Trello JS library :\ -->
		<script type="text/javascript" src="https://code.jquery.com/jquery-1.7.1.min.js"></script>
		<script type="text/javascript" src="https://api.trello.com/1/client.js?key=1f8851f412dc58b2eed7faf5b6d10aa7"></script>
		
		<script type="text/javascript">
			var GROCERIES_BOARD_ID = 'uO26DySr',
				INGREDIENT_LIST_IDS = [
					'5c872792a509cf2e8c82df33', // Have
					'55a407b199712e482a4a342d' // Low on, maybe get
				],
				TRELLO_CARDS_GET_URL = '/boards/' + GROCERIES_BOARD_ID + '/cards',
				RECIPES_JSON_URL = 'recipes.json';
			
			var ingredients = [],
				recipes,
				authBtn,
				progressBar;
			
			window.onload = function () {
				authBtn = document.getElementById('authBtn');
				progressBar = document.getElementById('progressBar');
				
				var trelloAuthParams = {
					type: 'popup',
					name: 'MealZ',
					persist: true,
					interactive: false,
					scope: {
						read: true,
						write: false,
						account: false
					},
					expiration: 'never',
					success: handleAuthSuccess,
					error: function () {
						// If silent auth fails, try interactive auth.
						trelloAuthParams.interactive = true;
						authBtn.onclick = function () {
							authBtn.disabled = true;
							progressBar.value = 0;
							
							Trello.authorize(trelloAuthParams);
						};
						authBtn.style.display = 'inline-block';
					}
				};
				
				Trello.authorize(trelloAuthParams);
			};
			
			function handleAuthFailure(err) {
				if (typeof(err) !== 'undefined') {
					console.error(err);
				}
				alert('Failed to authorize :(');
			}
			function handleIngredientsFailure(err) {
				if (typeof(err) !== 'undefined') {
					console.error(err);
				}
				alert('Failed to get ingredients list :(');
			}
			function handleRecipesFailure(err) {
				if (typeof(err) !== 'undefined') {
					console.error(err);
				}
				alert('Failed to get recipes :(');
			}
			
			function handleAuthSuccess() {
				authBtn.style.display = 'none';
				progressBar.value = 1;
				
				Trello.get(TRELLO_CARDS_GET_URL, {}, handleIngredientsSuccess, handleIngredientsFailure);
			}
			function handleIngredientsSuccess(items) {
				progressBar.value = 2;
				
				items.forEach(function (item) {
					if (INGREDIENT_LIST_IDS.indexOf(item.idList) !== -1) {
						ingredients.push(item.shortLink);
					}
				});
				
				progressBar.value = 3;
				
				getRecipes()
					.then(handleRecipesSuccess)
					.catch(handleRecipesFailure);
			}
			async function getRecipes() {
				let recipesRes = await fetch(RECIPES_JSON_URL),
					recipesJSON = await recipesRes.json();
				return recipesJSON;
			}
			function handleRecipesSuccess(recipes) {
				progressBar.value = 4;
				
				var list = document.getElementById('recipesList');
				for (let [categoryName, categoryRecipes] of Object.entries(recipes)) {
					
					appendCategoryHeading(categoryName, list);
					
					for (let recipe of categoryRecipes) {
						if (canMakeRecipe(recipe)) {
							appendRecipe(recipe, list);
						}
					}
				}
				
				progressBar.value = 5;
				
				// Hide the progress bar.
				document.getElementById('progressBar').style.display = 'none';
			}
			
			function canMakeRecipe(recipe) {
				for (let ingredient of recipe.ingredients) {
					if (!Array.isArray(ingredient)) {
						if (!ingredients.includes(ingredient.cardLink)) {
							return false;
						}
						continue;
					} else {
						let hasIngredient = false;
						for (let ingredientVariant of ingredient) {
							if (ingredients.includes(ingredientVariant.cardLink)) {
								hasIngredient = true;
							}
						}
						if (!hasIngredient) {
							return false;
						}
					}
				}
				return true;
			}
			
			function appendCategoryHeading(categoryName, list) {
				let newItem = document.createElement('li'),
					newHeading = document.createElement('h2');
				newHeading.textContent = categoryName;
				newItem.appendChild(newHeading);
				list.appendChild(newItem);
			}
			
			function appendRecipe(recipe, list) {
				let newItem = document.createElement('li');
				if (recipe.gdoc) {
					let newLink = document.createElement('a');
					newLink.textContent = recipe.title;
					newLink.href = recipe.gdoc;
					newLink.target = '_blank';
					newItem.appendChild(newLink);
				} else {
					newItem.textContent = recipe.title;
				}
				list.appendChild(newItem);
			}
		</script>
		<style type="text/css">
			html {
				background-color: #e8e8e8;
			}
			@media (prefers-color-scheme: dark) {
				html {
					background-color: #121212;
				}
			}
			body.card {
				max-width: 512px;
				margin: auto;
				text-align: center;
			}
			#progressBar {
				display: block;
				margin: auto;
			}
			#authBtn {
				display: none;
			}
			#recipesList {
				margin: auto;
				text-align: left;
				
				li:has(h2) {
					list-style-type: none;
				}
			}
		</style>
	</head>
	<body class="card z1">
		<progress id="progressBar" min="0" max="5"></progress>
		<button type="button" class="z1" id="authBtn">Authenticate with Trello</button>
		<ul id="recipesList"></ul>
	</body>
</html>
